---
title: "Database Queries and Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Database Queries and Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Introduction

The Demonax Tools Rust CLI provides commands for parsing game data and tracking player progress over time. This vignette demonstrates how to populate the database using the CLI and query it using SQL and R.

## Database Schema

The database contains tables organized by category:

### Player Data Tables (5)

- **players**: Player names and activity dates (id, name, first_seen, last_seen)
- **daily_snapshots**: Daily player stats (level, experience, magic_level, skills, equipment_json)
- **daily_quests**: Quest completion data per snapshot (quest_id, completion_count)
- **daily_bestiary**: Monster kill counts per snapshot (monster_id, kill_count)
- **daily_harvesting**: Harvesting progress per snapshot (race_id, harvest_count)

### Creature Data Tables (6)

- **creatures**: Monster definitions (race, name, hp, experience, type, article, avg_value)
- **creature_loot**: Loot drop tables with chances (1-999 raw, calculated percentages)
- **creature_flags**: Boolean flags for creatures (e.g., CanPushItems, CanOpenDoors)
- **creature_skills**: Creature combat stats (HitPoints, GoStrength, FistFighting, etc.)
- **creature_spells**: Creature abilities and attacks (spell_name, damage_type, range, etc.)
- **item_loot_sources**: Reverse lookup of which creatures drop each item

### Item Data Tables (2)

- **items**: Item metadata (type_id, name, flags, attributes, rewarded_from)
- **item_prices**: NPC buy/sell prices (npc_name, price, mode)

### Game Content Tables (6)

- **quests**: Quest chest locations and rewards (name, chest_location, reward_items_json)
- **raids**: Raid event definitions and spawn compositions
- **spells**: Spell definitions (words, mana, level, spell_type, premium)
- **spell_teachers**: NPCs teaching spells (npc_name, spell_id, vocation, price, level_required)
- **rune_sellers**: NPCs selling runes/wands/rods (npc_name, item_id, price, item_category)
- **harvesting_data**: Harvesting recipes (tool_id, corpse_id, reward_id, percent_chance)

## Populating the Database

Use the Rust CLI to populate the database with game data:

```bash
# Build the Rust CLI
cd ~/repos/demonax-tools
cargo build --release

# Process player data
./target/release/demonax --database progress.db \
  process-usr \
  --input-dir ~/game/usr \
  --snapshot-date 2026-01-07

# Update creature data
./target/release/demonax --database progress.db \
  update-creatures \
  --game-path ~/game

# Update items and prices
./target/release/demonax --database progress.db \
  update-items-core \
  --game-path ~/game

# Update quest data
./target/release/demonax --database progress.db \
  update-quest-overview \
  --game-path ~/game

# Link quest rewards to items
./target/release/demonax --database progress.db \
  update-items-quests \
  --game-path ~/game

# Update spells
./target/release/demonax --database progress.db \
  update-spells \
  --magic-cc ~/repos/tibia-game/src/magic.cc \
  --game-path ~/game

# Update raids
./target/release/demonax --database progress.db \
  update-raids \
  --game-path ~/game

# Update harvesting recipes
./target/release/demonax --database progress.db \
  update-harvesting \
  --harvesting-csv ~/repos/demonax-data/csv/harvesting.csv
```

## Quick Query Examples

These examples show common queries using DBI. For more detailed analysis, see the sections below.

```{r}
library(DBI)
db <- dbConnect(RSQLite::SQLite(), "progress.db")

# Top players by level for a specific date
dbGetQuery(db, "
  SELECT p.name, ds.level, ds.experience
  FROM daily_snapshots ds
  JOIN players p ON ds.player_id = p.id
  WHERE ds.snapshot_date = '2026-01-07'
  ORDER BY ds.level DESC
")

# Check bestiary progress for a player
dbGetQuery(db, "
  SELECT p.name, b.monster_id, b.kill_count
  FROM daily_bestiary b
  JOIN daily_snapshots ds ON b.snapshot_id = ds.id
  JOIN players p ON ds.player_id = p.id
  WHERE p.name = 'PlayerName'
")

# Check harvesting progress
dbGetQuery(db, "
  SELECT p.name, h.race_id, h.harvest_count
  FROM daily_harvesting h
  JOIN daily_snapshots ds ON h.snapshot_id = ds.id
  JOIN players p ON ds.player_id = p.id
  WHERE p.name = 'PlayerName'
")

dbDisconnect(db)
```

## R Integration

### Setup

```{r}
library(DBI)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(jsonlite)

db <- dbConnect(RSQLite::SQLite(), "progress.db")

players <- dbReadTable(db, "players") |> as_tibble()
snapshots <- dbReadTable(db, "daily_snapshots") |> as_tibble()
bestiary <- dbReadTable(db, "daily_bestiary") |> as_tibble()
quests <- dbReadTable(db, "daily_quests") |> as_tibble()
harvesting <- dbReadTable(db, "daily_harvesting") |> as_tibble()
```

## Player Analysis

### Player Skills Analysis

```{r}
player_skills <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  filter(snapshot_date == "2026-01-07")

player_skills |>
  arrange(desc(level)) |>
  select(name, level, experience, magic_level)

exp_gains <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  arrange(name, snapshot_date) |>
  group_by(name) |>
  mutate(
    exp_gain = experience - lag(experience, default = 0),
    level_gain = level - lag(level, default = 0)
  ) |>
  filter(exp_gain > 0)

exp_gains |>
  ggplot(aes(x = as.Date(snapshot_date), y = exp_gain, color = name)) +
  geom_line() +
  labs(title = "Daily Experience Gains", x = "Date", y = "Experience")
```

### Bestiary Tracking

```{r}
player_bestiary <- bestiary |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id")) |>
  select(name, snapshot_date, monster_id, kill_count)

player_bestiary |>
  filter(name == "PlayerName") |>
  arrange(snapshot_date, monster_id)

player_bestiary |>
  group_by(name) |>
  summarize(
    total_kills = sum(kill_count),
    unique_monsters = n_distinct(monster_id)
  ) |>
  arrange(desc(total_kills))

player_bestiary |>
  filter(monster_id == 21) |>
  group_by(name) |>
  summarize(total_kills = sum(kill_count)) |>
  arrange(desc(total_kills))

latest_date <- max(snapshots$snapshot_date)
player_bestiary |>
  filter(snapshot_date == latest_date) |>
  arrange(name, monster_id)

player_bestiary |>
  filter(name == "PlayerName") |>
  group_by(snapshot_date) |>
  summarize(
    unique_monsters = n_distinct(monster_id),
    total_kills = sum(kill_count)
  ) |>
  ggplot(aes(x = as.Date(snapshot_date), y = unique_monsters)) +
  geom_line() +
  labs(title = "Bestiary Completion", x = "Date", y = "Unique Monsters")
```

### Harvesting Progress Tracking

```{r}
player_harvesting <- harvesting |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id")) |>
  select(name, snapshot_date, race_id, harvest_count)

player_harvesting |>
  filter(name == "PlayerName") |>
  arrange(snapshot_date, race_id)

player_harvesting |>
  group_by(name) |>
  summarize(
    total_harvests = sum(harvest_count),
    unique_races = n_distinct(race_id)
  ) |>
  arrange(desc(total_harvests))

player_harvesting |>
  filter(race_id == 10) |>
  group_by(name) |>
  summarize(total_harvests = sum(harvest_count)) |>
  arrange(desc(total_harvests))

player_harvesting |>
  filter(name == "PlayerName") |>
  group_by(snapshot_date) |>
  summarize(
    unique_races = n_distinct(race_id),
    total_harvests = sum(harvest_count)
  ) |>
  ggplot(aes(x = as.Date(snapshot_date), y = unique_races)) +
  geom_line() +
  labs(title = "Harvesting Progress", x = "Date", y = "Unique Races Harvested")
```

### Quest Analysis

```{r}
quest_data <- quests |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id"))

quest_data |>
  group_by(quest_id) |>
  summarize(
    players = n_distinct(name),
    total_completions = sum(completion_count)
  ) |>
  arrange(desc(players))

quest_data |>
  group_by(snapshot_date, quest_id) |>
  summarize(completions = sum(completion_count), .groups = "drop") |>
  ggplot(aes(
    x = as.Date(snapshot_date),
    y = completions,
    color = factor(quest_id)
  )) +
  geom_line() +
  labs(title = "Quest Completions Over Time", x = "Date", y = "Completions")
```

### Equipment Analysis

```{r}
equipment_data <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  mutate(
    equipment = map(equipment_json, fromJSON),
    item_count = map_int(equipment, ~ sum(!is.na(.)))
  )

equipment_data |>
  arrange(desc(item_count)) |>
  select(name, snapshot_date, item_count)

equipment_data |>
  filter(name == "PlayerName") |>
  ggplot(aes(x = as.Date(snapshot_date), y = item_count)) +
  geom_line() +
  labs(title = "Equipment Slots Filled Over Time", x = "Date", y = "Items")
```

## Creature and Loot Analysis

### Creature Statistics

```{r}
creatures <- dbReadTable(db, "creatures") |> as_tibble()
creature_loot <- dbReadTable(db, "creature_loot") |> as_tibble()

# Top creatures by experience
creatures |>
  select(name, article, type, experience, hp) |>
  arrange(desc(experience)) |>
  head(10)

# Count creatures by type
creatures |>
  count(type) |>
  arrange(desc(n))

# Bosses (empty article)
creatures |>
  filter(article == "") |>
  select(name, experience, hp) |>
  arrange(desc(experience))

# Regular creatures
creatures |>
  filter(article %in% c("a", "an")) |>
  select(name, article, experience, hp) |>
  arrange(desc(experience)) |>
  head(20)
```

```{r}
# Visualize creature difficulty distribution
creatures |>
  ggplot(aes(x = experience, y = hp, color = type)) +
  geom_point(alpha = 0.6) +
  scale_x_log10() +
  scale_y_log10() +
  labs(title = "Creature Difficulty", x = "Experience", y = "Hit Points")

# Distribution by type
creatures |>
  count(type) |>
  ggplot(aes(x = reorder(type, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Creatures by Type", x = "Type", y = "Count")
```

### Loot Drop Analysis

```{r}
# Loot table for a specific creature
creature_loot |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(name == "demon") |>
  select(name, item_id, min_amount, max_amount, chance_raw, chance_percent) |>
  arrange(desc(chance_percent))

# Items with highest drop rates (>= 99%)
creature_loot |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(chance_percent >= 99) |>
  select(name, item_id, chance_percent) |>
  arrange(name, item_id)

# Ultra-rare drops (0.2% chance, raw = 1)
creature_loot |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(chance_raw == 1) |>
  select(name, item_id, chance_percent) |>
  arrange(name)

# Creatures with most loot variety
creature_loot |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  count(name, name = "loot_items") |>
  arrange(desc(loot_items)) |>
  head(10)
```

```{r}
# Loot chance distribution
loot_summary <- creature_loot |>
  group_by(creature_id) |>
  summarize(
    loot_items = n(),
    avg_chance = mean(chance_percent),
    guaranteed_drops = sum(chance_raw == 999)
  ) |>
  left_join(creatures, by = c("creature_id" = "id"))

loot_summary |>
  ggplot(aes(x = loot_items, y = avg_chance)) +
  geom_point(alpha = 0.6) +
  labs(title = "Creature Loot Tables",
       x = "Number of Loot Items",
       y = "Average Drop Chance %")

# Loot chance histogram
creature_loot |>
  ggplot(aes(x = chance_percent)) +
  geom_histogram(bins = 50) +
  labs(title = "Loot Drop Chance Distribution",
       x = "Drop Chance %",
       y = "Count")
```

**Note:** Loot chances range from 1-999 (raw values), corresponding to 0.2%-100% drop rates. The formula is: `(chance_raw + 1) / 999 * 100`.

### Creature Details (Skills, Spells, Flags)

Additional creature data is stored in separate tables for skills, spells, and flags.

```{r}
creature_skills <- dbReadTable(db, "creature_skills") |> as_tibble()
creature_spells <- dbReadTable(db, "creature_spells") |> as_tibble()
creature_flags <- dbReadTable(db, "creature_flags") |> as_tibble()

# Get all skills for a creature
creature_skills |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(name == "dragon") |>
  select(name, skill_name, skill_value) |>
  arrange(skill_name)

# Get all spells/attacks for a creature
creature_spells |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(name == "dragon") |>
  select(name, spell_name, spell_category, damage_type, min_value, max_value, range) |>
  arrange(spell_order)

# Creatures with specific flags
creature_flags |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(flag_name == "CanPushItems") |>
  select(name, flag_name) |>
  head(20)

# Most common creature flags
creature_flags |>
  count(flag_name, name = "creature_count") |>
  arrange(desc(creature_count))

# Spell types used by creatures
creature_spells |>
  count(spell_category) |>
  arrange(desc(n))
```

### Item Loot Sources

The item_loot_sources table provides a reverse lookup to find which creatures drop each item.

```{r}
item_loot_sources <- dbReadTable(db, "item_loot_sources") |> as_tibble()

# Find all creatures that drop a specific item (e.g., gold coin = 3031)
item_loot_sources |>
  left_join(creatures, by = c("creature_id" = "id")) |>
  filter(item_id == 3031) |>
  select(name, drop_chance, average_value) |>
  arrange(desc(drop_chance))

# Items with most creature sources
item_loot_sources |>
  count(item_id, name = "source_count") |>
  arrange(desc(source_count)) |>
  head(20)
```

## Item and Economy Analysis

### Item Database

```{r}
items <- dbReadTable(db, "items") |> as_tibble()
item_prices <- dbReadTable(db, "item_prices") |> as_tibble()

# Most expensive items to buy from NPCs
item_prices |>
  left_join(items, by = c("item_id" = "type_id")) |>
  filter(mode == "buy") |>
  select(name, npc_name, price) |>
  arrange(desc(price)) |>
  head(20)

# Best selling prices (items NPCs will buy)
item_prices |>
  left_join(items, by = c("item_id" = "type_id")) |>
  filter(mode == "sell") |>
  select(name, npc_name, price) |>
  arrange(desc(price)) |>
  head(20)

# Quest reward items
items |>
  filter(!is.na(rewarded_from)) |>
  select(type_id, name, rewarded_from) |>
  arrange(type_id)

# Find NPCs trading a specific item (e.g., items with "sword" in name)
item_prices |>
  left_join(items, by = c("item_id" = "type_id")) |>
  filter(str_detect(name, regex("sword", ignore_case = TRUE))) |>
  select(npc_name, mode, price, name) |>
  arrange(price)
```

```{r}
# Price comparison analysis
price_comparison <- item_prices |>
  pivot_wider(
    id_cols = item_id,
    names_from = mode,
    values_from = price,
    values_fn = mean
  ) |>
  left_join(items, by = c("item_id" = "type_id"))

price_comparison |>
  filter(!is.na(buy) & !is.na(sell)) |>
  mutate(margin = buy - sell) |>
  arrange(desc(margin)) |>
  select(name, buy, sell, margin) |>
  head(20)

# Price distribution
item_prices |>
  ggplot(aes(x = price, fill = mode)) +
  geom_histogram(bins = 50) +
  scale_x_log10() +
  labs(title = "Item Price Distribution", x = "Price (log scale)", y = "Count")
```

## Spell and Magic System

### Spell Database

```{r}
spells <- dbReadTable(db, "spells") |> as_tibble()
spell_teachers <- dbReadTable(db, "spell_teachers") |> as_tibble()

# All spells sorted by level and mana
spells |>
  select(name, words, spell_type, level, mana, premium) |>
  arrange(level, mana)

# Most expensive spells to learn
spell_teachers |>
  left_join(spells, by = c("spell_id" = "id")) |>
  select(npc_name, name, words, price, vocation, level_required) |>
  arrange(desc(price)) |>
  head(20)

# NPCs teaching the most spells
spell_teachers |>
  count(npc_name, name = "spells_taught") |>
  arrange(desc(spells_taught))

# Spells by vocation
spell_teachers |>
  group_by(vocation) |>
  summarize(spell_count = n_distinct(spell_id)) |>
  arrange(desc(spell_count))

# Spells taught by a specific NPC
spell_teachers |>
  left_join(spells, by = c("spell_id" = "id")) |>
  filter(npc_name == "Elane") |>
  select(name, words, vocation, price, level_required) |>
  arrange(price)

# Premium vs free spells
spells |>
  count(premium, name = "spell_count")
```

```{r}
# Spell cost by level
spell_costs <- spell_teachers |>
  left_join(spells, by = c("spell_id" = "id"))

spell_costs |>
  ggplot(aes(x = level, y = price, color = vocation)) +
  geom_point(alpha = 0.6) +
  labs(title = "Spell Teaching Costs", x = "Level Required", y = "Price (gp)")

# Spells by type
spells |>
  count(spell_type) |>
  ggplot(aes(x = reorder(spell_type, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Spells by Type", x = "Spell Type", y = "Count")
```

### Rune and Wand/Rod Sellers

The rune_sellers table tracks NPCs that sell runes, wands, and rods.

```{r}
rune_sellers <- dbReadTable(db, "rune_sellers") |> as_tibble()

# All rune sellers sorted by category and price
rune_sellers |>
  select(npc_name, item_id, price, item_category, vocation) |>
  arrange(item_category, price)

# Count by category
rune_sellers |>
  count(item_category)

# Find where to buy a specific rune (e.g., item_id = 2268)
rune_sellers |>
  filter(item_id == 2268) |>
  select(npc_name, price, vocation, charges) |>
  arrange(price)
```

## Raid Events

```{r}
raids <- dbReadTable(db, "raids") |> as_tibble()

# All raids with frequency
raids |>
  select(name, type, interval_days, creatures, waves) |>
  arrange(interval_days)

# Cyclic raids (recurring events)
raids |>
  filter(type == "cyclic") |>
  select(name, interval_days, waves, message) |>
  arrange(interval_days)

# Raids by wave count
raids |>
  count(waves, name = "raid_count") |>
  arrange(desc(raid_count))
```

```{r}
# Raid frequency distribution
raids |>
  filter(!is.na(interval_days)) |>
  ggplot(aes(x = interval_days)) +
  geom_histogram(bins = 20) +
  labs(title = "Raid Frequency Distribution", x = "Interval (days)", y = "Count")
```

## Quest Locations

The quests table stores chest_location as a text field containing coordinates in the format "x,y,z (sector)".

```{r}
quest_locations <- dbReadTable(db, "quests") |> as_tibble()

# Parse chest_location into separate x, y, z columns
quest_locations <- quest_locations |>
  mutate(
    coords = str_extract(chest_location, "^[0-9]+,[0-9]+,[0-9]+"),
    x = as.integer(str_extract(coords, "^[0-9]+")),
    y = as.integer(str_extract(coords, "(?<=,)[0-9]+(?=,)")),
    z = as.integer(str_extract(coords, "[0-9]+$"))
  )
```

```{r}
# All quests with locations
quest_locations |>
  select(id, name, chest_location, reward_items_json) |>
  head(20)

# Quests containing specific reward item (item ID in JSON array, e.g., 3031 = gold)
quest_locations |>
  filter(str_detect(reward_items_json, "3031")) |>
  select(name, chest_location, reward_items_json) |>
  head(20)

# Count quests by Z level (using parsed coordinates)
quest_locations |>
  filter(!is.na(z)) |>
  count(z, name = "quest_count") |>
  arrange(desc(quest_count))
```

```{r}
# Quest distribution by floor (after parsing coordinates)
quest_locations |>
  filter(!is.na(z)) |>
  count(z) |>
  ggplot(aes(x = z, y = n)) +
  geom_col() +
  labs(title = "Quest Distribution by Floor", x = "Floor (Z)", y = "Quest Count")

# Quest map (X/Y coordinates)
quest_locations |>
  filter(z == 7) |>
  ggplot(aes(x = x, y = y)) +
  geom_point(alpha = 0.6) +
  labs(title = "Quest Locations (Floor 7)", x = "X Coordinate", y = "Y Coordinate")
```

## Harvesting Mechanics

This table contains harvesting recipes (game mechanics), not player harvesting progress.

```{r}
harvesting_recipes <- dbReadTable(db, "harvesting_data") |> as_tibble()
```

```{r}
# All harvesting recipes
harvesting_recipes |>
  select(tool_id, corpse_id, next_corpse_id, percent_chance, reward_id, race_id) |>
  arrange(desc(percent_chance))

# Recipes by tool
harvesting_recipes |>
  count(tool_id, name = "recipes")

# Find what rewards come from harvesting a specific corpse (e.g., 3101)
harvesting_recipes |>
  filter(corpse_id == 3101) |>
  select(corpse_id, reward_id, percent_chance) |>
  arrange(desc(percent_chance))
```

```{r}
# Harvesting success rate distribution
harvesting_recipes |>
  ggplot(aes(x = percent_chance)) +
  geom_histogram(bins = 20) +
  labs(title = "Harvesting Success Rate Distribution",
       x = "Success Rate %",
       y = "Count")
```

## Closing Database Connection

```{r}
dbDisconnect(db)
```

## Skill IDs Reference

When parsing .usr files, skills are identified by the following IDs:

| Skill ID | Skill Name        |
|----------|-------------------|
| 0        | Level             |
| 1        | Magic Level       |
| 6        | Fist Fighting     |
| 7        | Club Fighting     |
| 8        | Sword Fighting    |
| 9        | Axe Fighting      |
| 10       | Distance Fighting |
| 11       | Shielding         |
| 14       | Fishing           |

## USR File Format

The .usr files contain player data in the following format:

```
ID              = 100001
Name            = "PlayerName"
...
Skill = (0,108,0,1,0,0,0,0,0,0,1,20000100,0,20426400,100)  # Level/Exp
Skill = (1,75,0,1,0,0,0,0,0,0,1,20000100,0,20426400,100)   # Magic Level
...
QuestValues = {(20,1),(25,1),(227,5)}
Bestiary    = {(15,8),(21,6),(27,3)}
Harvesting  = {(10,5),(15,3),(20,1)}
Inventory   = {3 Content={5272}, 10 Content={2854}}
```

## Session Info

```{r, eval = TRUE}
sessionInfo()
```
