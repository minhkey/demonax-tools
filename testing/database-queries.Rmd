---
title: "Database Queries and Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Database Queries and Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Introduction

The Demonax Tools Rust CLI provides commands for parsing game data and tracking player progress over time. This vignette demonstrates how to populate the database using the CLI and query it using SQL and R.

## Database Schema

The database contains thirteen main tables organized by category:

### Player Data Tables (5)

- **players**: Player names and activity dates (id, name, first_seen, last_seen)
- **daily_snapshots**: Daily player stats (level, experience, skills, equipment)
- **daily_quests**: Quest completion data per snapshot
- **bestiary**: Monster kill counts per snapshot
- **harvesting**: Harvesting progress per snapshot (player tracking)

### Creature Data Tables (2)

- **creatures**: Monster definitions (race, name, hp, experience, attack, armor, article)
- **creature_loot**: Loot drop tables with chances (1-999 raw, calculated percentages)

### Item Data Tables (2)

- **items**: Item metadata (type_id, name, flags, attributes, rewarded_from)
- **item_prices**: NPC buy/sell prices

### Game Content Tables (4)

- **quests**: Quest chest locations and rewards
- **raids**: Raid event definitions and spawn compositions
- **spells**: Spell definitions (words, mana, level, spell_type)
- **spell_teachers**: NPCs teaching spells (with prices and requirements)
- **harvesting_data**: Harvesting recipes (tool/corpse/reward mechanics)

## Populating the Database

Use the Rust CLI to populate the database with game data:

```bash
# Build the Rust CLI
cd ~/repos/demonax-tools
cargo build --release

# Process player data
./target/release/demonax --database progress.db \
  process-usr \
  --input-dir ~/game/usr \
  --snapshot-date 2026-01-07

# Update creature data
./target/release/demonax --database progress.db \
  update-creatures \
  --game-path ~/game

# Update items and prices
./target/release/demonax --database progress.db \
  update-items-core \
  --game-path ~/game

# Update quest data
./target/release/demonax --database progress.db \
  update-quest-overview \
  --game-path ~/game

# Link quest rewards to items
./target/release/demonax --database progress.db \
  update-items-quests \
  --game-path ~/game

# Update spells
./target/release/demonax --database progress.db \
  update-spells \
  --magic-cc ~/repos/tibia-game/src/magic.cc \
  --game-path ~/game

# Update raids
./target/release/demonax --database progress.db \
  update-raids \
  --game-path ~/game

# Update harvesting recipes
./target/release/demonax --database progress.db \
  update-harvesting \
  --harvesting-csv ~/repos/demonax-data/csv/harvesting.csv
```

## Direct SQL Queries

### Query with SQLite CLI

```bash
# Top players by level
sqlite3 progress.db "
  SELECT p.name, ds.level, ds.experience
  FROM daily_snapshots ds
  JOIN players p ON ds.player_id = p.id
  WHERE ds.snapshot_date = '2026-01-07'
  ORDER BY ds.level DESC
"

# Check bestiary progress for a player
sqlite3 progress.db "
  SELECT p.name, b.monster_id, b.kill_count
  FROM bestiary b
  JOIN daily_snapshots ds ON b.snapshot_id = ds.id
  JOIN players p ON ds.player_id = p.id
  WHERE p.name = 'PlayerName'
"

# Check harvesting progress
sqlite3 progress.db "
  SELECT p.name, h.race_id, h.harvest_count
  FROM harvesting h
  JOIN daily_snapshots ds ON h.snapshot_id = ds.id
  JOIN players p ON ds.player_id = p.id
  WHERE p.name = 'PlayerName'
"
```

## R Integration

### Setup

```{r}
library(DBI)
library(dplyr)
library(tidyr)
library(ggplot2)
library(jsonlite)

db <- dbConnect(RSQLite::SQLite(), "progress.db")

players <- dbReadTable(db, "players") |> as_tibble()
snapshots <- dbReadTable(db, "daily_snapshots") |> as_tibble()
bestiary <- dbReadTable(db, "bestiary") |> as_tibble()
quests <- dbReadTable(db, "daily_quests") |> as_tibble()
harvesting <- dbReadTable(db, "harvesting") |> as_tibble()
```

## Player Analysis

### Player Skills Analysis

```{r}
player_skills <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  filter(snapshot_date == "2026-01-07")

player_skills |>
  arrange(desc(level)) |>
  select(name, level, experience, magic_level)

exp_gains <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  arrange(name, snapshot_date) |>
  group_by(name) |>
  mutate(
    exp_gain = experience - lag(experience, default = 0),
    level_gain = level - lag(level, default = 0)
  ) |>
  filter(exp_gain > 0)

exp_gains |>
  ggplot(aes(x = as.Date(snapshot_date), y = exp_gain, color = name)) +
  geom_line() +
  labs(title = "Daily Experience Gains", x = "Date", y = "Experience")
```

### Bestiary Tracking

```{r}
player_bestiary <- bestiary |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id")) |>
  select(name, snapshot_date, monster_id, kill_count)

player_bestiary |>
  filter(name == "PlayerName") |>
  arrange(snapshot_date, monster_id)

player_bestiary |>
  group_by(name) |>
  summarize(
    total_kills = sum(kill_count),
    unique_monsters = n_distinct(monster_id)
  ) |>
  arrange(desc(total_kills))

player_bestiary |>
  filter(monster_id == 21) |>
  group_by(name) |>
  summarize(total_kills = sum(kill_count)) |>
  arrange(desc(total_kills))

latest_date <- max(snapshots$snapshot_date)
player_bestiary |>
  filter(snapshot_date == latest_date) |>
  arrange(name, monster_id)

player_bestiary |>
  filter(name == "PlayerName") |>
  group_by(snapshot_date) |>
  summarize(
    unique_monsters = n_distinct(monster_id),
    total_kills = sum(kill_count)
  ) |>
  ggplot(aes(x = as.Date(snapshot_date), y = unique_monsters)) +
  geom_line() +
  labs(title = "Bestiary Completion", x = "Date", y = "Unique Monsters")
```

### Harvesting Progress Tracking

```{r}
player_harvesting <- harvesting |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id")) |>
  select(name, snapshot_date, race_id, harvest_count)

player_harvesting |>
  filter(name == "PlayerName") |>
  arrange(snapshot_date, race_id)

player_harvesting |>
  group_by(name) |>
  summarize(
    total_harvests = sum(harvest_count),
    unique_races = n_distinct(race_id)
  ) |>
  arrange(desc(total_harvests))

player_harvesting |>
  filter(race_id == 10) |>
  group_by(name) |>
  summarize(total_harvests = sum(harvest_count)) |>
  arrange(desc(total_harvests))

player_harvesting |>
  filter(name == "PlayerName") |>
  group_by(snapshot_date) |>
  summarize(
    unique_races = n_distinct(race_id),
    total_harvests = sum(harvest_count)
  ) |>
  ggplot(aes(x = as.Date(snapshot_date), y = unique_races)) +
  geom_line() +
  labs(title = "Harvesting Progress", x = "Date", y = "Unique Races Harvested")
```

### Quest Analysis

```{r}
quest_data <- quests |>
  left_join(snapshots, by = c("snapshot_id" = "id")) |>
  left_join(players, by = c("player_id" = "id"))

quest_data |>
  group_by(quest_id) |>
  summarize(
    players = n_distinct(name),
    total_completions = sum(completion_count)
  ) |>
  arrange(desc(players))

quest_data |>
  group_by(snapshot_date, quest_id) |>
  summarize(completions = sum(completion_count), .groups = "drop") |>
  ggplot(aes(
    x = as.Date(snapshot_date),
    y = completions,
    color = factor(quest_id)
  )) +
  geom_line() +
  labs(title = "Quest Completions Over Time", x = "Date", y = "Completions")
```

### Equipment Analysis

```{r}
equipment_data <- snapshots |>
  left_join(players, by = c("player_id" = "id")) |>
  mutate(
    equipment = map(equipment_json, fromJSON),
    item_count = map_int(equipment, ~ sum(!is.na(.)))
  )

equipment_data |>
  arrange(desc(item_count)) |>
  select(name, snapshot_date, item_count)

equipment_data |>
  filter(name == "PlayerName") |>
  ggplot(aes(x = as.Date(snapshot_date), y = item_count)) +
  geom_line() +
  labs(title = "Equipment Slots Filled Over Time", x = "Date", y = "Items")
```

## Creature and Loot Analysis

### Creature Statistics

```{r}
creatures <- dbReadTable(db, "creatures") |> as_tibble()
creature_loot <- dbReadTable(db, "creature_loot") |> as_tibble()
```

```bash
# Top creatures by experience
sqlite3 progress.db "
  SELECT name, article, type, experience, hp, attack, armor
  FROM creatures
  ORDER BY experience DESC
  LIMIT 10;
"

# Count creatures by type
sqlite3 progress.db "
  SELECT type, COUNT(*) as count
  FROM creatures
  GROUP BY type;
"

# Bosses (empty article)
sqlite3 progress.db "
  SELECT name, experience, hp
  FROM creatures
  WHERE article = ''
  ORDER BY experience DESC;
"

# Regular creatures
sqlite3 progress.db "
  SELECT name, article, experience, hp
  FROM creatures
  WHERE article IN ('a', 'an')
  ORDER BY experience DESC
  LIMIT 20;
"
```

```{r}
# Visualize creature difficulty distribution
creatures |>
  ggplot(aes(x = experience, y = hp, color = type)) +
  geom_point(alpha = 0.6) +
  scale_x_log10() +
  scale_y_log10() +
  labs(title = "Creature Difficulty", x = "Experience", y = "Hit Points")

# Distribution by type
creatures |>
  count(type) |>
  ggplot(aes(x = reorder(type, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Creatures by Type", x = "Type", y = "Count")
```

### Loot Drop Analysis

```bash
# Loot table for a specific creature
sqlite3 progress.db "
  SELECT c.name, cl.item_id, cl.min_amount, cl.max_amount,
         cl.chance_raw, cl.chance_percent
  FROM creature_loot cl
  JOIN creatures c ON cl.creature_id = c.id
  WHERE c.name = 'demon'
  ORDER BY cl.chance_percent DESC;
"

# Items with highest drop rates (>= 99%)
sqlite3 progress.db "
  SELECT c.name, cl.item_id, cl.chance_percent
  FROM creature_loot cl
  JOIN creatures c ON cl.creature_id = c.id
  WHERE cl.chance_percent >= 99
  ORDER BY c.name, cl.item_id;
"

# Ultra-rare drops (0.2% chance, raw = 1)
sqlite3 progress.db "
  SELECT c.name, cl.item_id, cl.chance_percent
  FROM creature_loot cl
  JOIN creatures c ON cl.creature_id = c.id
  WHERE cl.chance_raw = 1
  ORDER BY c.name;
"

# Creatures with most loot variety
sqlite3 progress.db "
  SELECT c.name, COUNT(*) as loot_items
  FROM creature_loot cl
  JOIN creatures c ON cl.creature_id = c.id
  GROUP BY c.id
  ORDER BY loot_items DESC
  LIMIT 10;
"
```

```{r}
# Loot chance distribution
loot_summary <- creature_loot |>
  group_by(creature_id) |>
  summarize(
    loot_items = n(),
    avg_chance = mean(chance_percent),
    guaranteed_drops = sum(chance_raw == 999)
  ) |>
  left_join(creatures, by = c("creature_id" = "id"))

loot_summary |>
  ggplot(aes(x = loot_items, y = avg_chance)) +
  geom_point(alpha = 0.6) +
  labs(title = "Creature Loot Tables",
       x = "Number of Loot Items",
       y = "Average Drop Chance %")

# Loot chance histogram
creature_loot |>
  ggplot(aes(x = chance_percent)) +
  geom_histogram(bins = 50) +
  labs(title = "Loot Drop Chance Distribution",
       x = "Drop Chance %",
       y = "Count")
```

**Note:** Loot chances range from 1-999 (raw values), corresponding to 0.2%-100% drop rates. The formula is: `(chance_raw + 1) / 999 * 100`.

## Item and Economy Analysis

### Item Database

```{r}
items <- dbReadTable(db, "items") |> as_tibble()
item_prices <- dbReadTable(db, "item_prices") |> as_tibble()
```

```bash
# Most expensive items to buy from NPCs
sqlite3 progress.db "
  SELECT i.name, ip.npc_name, ip.price
  FROM items i
  JOIN item_prices ip ON i.type_id = ip.item_id
  WHERE ip.mode = 'buy'
  ORDER BY ip.price DESC
  LIMIT 20;
"

# Best selling prices (items NPCs will buy)
sqlite3 progress.db "
  SELECT i.name, ip.npc_name, ip.price
  FROM items i
  JOIN item_prices ip ON i.type_id = ip.item_id
  WHERE ip.mode = 'sell'
  ORDER BY ip.price DESC
  LIMIT 20;
"

# Quest reward items
sqlite3 progress.db "
  SELECT type_id, name, rewarded_from
  FROM items
  WHERE rewarded_from IS NOT NULL
  ORDER BY type_id;
"

# Find NPCs trading a specific item
sqlite3 progress.db "
  SELECT ip.npc_name, ip.mode, ip.price
  FROM item_prices ip
  JOIN items i ON ip.item_id = i.type_id
  WHERE i.name LIKE '%sword%'
  ORDER BY ip.price;
"

# Price comparison (buy vs sell for same item)
sqlite3 progress.db "
  SELECT
    i.name,
    MAX(CASE WHEN ip.mode = 'buy' THEN ip.price END) as buy_price,
    MAX(CASE WHEN ip.mode = 'sell' THEN ip.price END) as sell_price
  FROM items i
  JOIN item_prices ip ON i.type_id = ip.item_id
  GROUP BY i.type_id
  HAVING buy_price IS NOT NULL AND sell_price IS NOT NULL
  ORDER BY (buy_price - sell_price) DESC
  LIMIT 20;
"
```

```{r}
# Price comparison analysis
price_comparison <- item_prices |>
  pivot_wider(
    id_cols = item_id,
    names_from = mode,
    values_from = price,
    values_fn = mean
  ) |>
  left_join(items, by = c("item_id" = "type_id"))

price_comparison |>
  filter(!is.na(buy) & !is.na(sell)) |>
  mutate(margin = buy - sell) |>
  arrange(desc(margin)) |>
  select(name, buy, sell, margin) |>
  head(20)

# Price distribution
item_prices |>
  ggplot(aes(x = price, fill = mode)) +
  geom_histogram(bins = 50) +
  scale_x_log10() +
  labs(title = "Item Price Distribution", x = "Price (log scale)", y = "Count")
```

## Spell and Magic System

### Spell Database

```{r}
spells <- dbReadTable(db, "spells") |> as_tibble()
spell_teachers <- dbReadTable(db, "spell_teachers") |> as_tibble()
```

```bash
# All spells sorted by level and mana
sqlite3 progress.db "
  SELECT name, words, spell_type, level, mana, premium
  FROM spells
  ORDER BY level, mana;
"

# Most expensive spells to learn
sqlite3 progress.db "
  SELECT st.npc_name, s.name, s.words, st.price, st.vocation, st.level_required
  FROM spell_teachers st
  JOIN spells s ON st.spell_id = s.id
  ORDER BY st.price DESC
  LIMIT 20;
"

# NPCs teaching the most spells
sqlite3 progress.db "
  SELECT npc_name, COUNT(*) as spells_taught
  FROM spell_teachers
  GROUP BY npc_name
  ORDER BY spells_taught DESC;
"

# Spells by vocation
sqlite3 progress.db "
  SELECT st.vocation, COUNT(DISTINCT st.spell_id) as spell_count
  FROM spell_teachers st
  GROUP BY st.vocation
  ORDER BY spell_count DESC;
"

# Spells taught by a specific NPC
sqlite3 progress.db "
  SELECT s.name, s.words, st.vocation, st.price, st.level_required
  FROM spell_teachers st
  JOIN spells s ON st.spell_id = s.id
  WHERE st.npc_name = 'Elane'
  ORDER BY st.price;
"

# Premium vs free spells
sqlite3 progress.db "
  SELECT premium, COUNT(*) as spell_count
  FROM spells
  GROUP BY premium;
"
```

```{r}
# Spell cost by level
spell_costs <- spell_teachers |>
  left_join(spells, by = c("spell_id" = "id"))

spell_costs |>
  ggplot(aes(x = level, y = price, color = vocation)) +
  geom_point(alpha = 0.6) +
  labs(title = "Spell Teaching Costs", x = "Level Required", y = "Price (gp)")

# Spells by type
spells |>
  count(spell_type) |>
  ggplot(aes(x = reorder(spell_type, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Spells by Type", x = "Spell Type", y = "Count")
```

## Raid Events

```{r}
raids <- dbReadTable(db, "raids") |> as_tibble()
```

```bash
# All raids with frequency
sqlite3 progress.db "
  SELECT name, type, interval_days, creatures, waves
  FROM raids
  ORDER BY interval_days;
"

# Cyclic raids (recurring events)
sqlite3 progress.db "
  SELECT name, interval_days, waves, message
  FROM raids
  WHERE type = 'cyclic'
  ORDER BY interval_days;
"

# Raids by wave count
sqlite3 progress.db "
  SELECT waves, COUNT(*) as raid_count
  FROM raids
  GROUP BY waves
  ORDER BY raid_count DESC;
"
```

```{r}
# Raid frequency distribution
raids |>
  filter(!is.na(interval_days)) |>
  ggplot(aes(x = interval_days)) +
  geom_histogram(bins = 20) +
  labs(title = "Raid Frequency Distribution", x = "Interval (days)", y = "Count")
```

## Quest Locations

```{r}
quest_locations <- dbReadTable(db, "quests") |> as_tibble()
```

```bash
# Quests by area (Z level)
sqlite3 progress.db "
  SELECT z, COUNT(*) as quest_count
  FROM quests
  GROUP BY z
  ORDER BY quest_count DESC;
"

# All quest locations
sqlite3 progress.db "
  SELECT name, x, y, z, rewards
  FROM quests
  ORDER BY z, x, y;
"

# Quests containing specific rewards (parse JSON)
sqlite3 progress.db "
  SELECT name, x, y, z, rewards
  FROM quests
  WHERE rewards LIKE '%3031%'
  LIMIT 20;
"
```

```{r}
# Quest distribution by floor
quest_locations |>
  count(z) |>
  ggplot(aes(x = z, y = n)) +
  geom_col() +
  labs(title = "Quest Distribution by Floor", x = "Floor (Z)", y = "Quest Count")

# Quest map (X/Y coordinates)
quest_locations |>
  filter(z == 7) |>
  ggplot(aes(x = x, y = y)) +
  geom_point(alpha = 0.6) +
  labs(title = "Quest Locations (Floor 7)", x = "X Coordinate", y = "Y Coordinate")
```

## Harvesting Mechanics

This table contains harvesting recipes (game mechanics), not player harvesting progress.

```{r}
harvesting_recipes <- dbReadTable(db, "harvesting_data") |> as_tibble()
```

```bash
# All harvesting recipes
sqlite3 progress.db "
  SELECT tool_id, corpse_id, next_corpse_id, percent_chance, reward_id, race_id
  FROM harvesting_data
  ORDER BY percent_chance DESC;
"

# Recipes by tool
sqlite3 progress.db "
  SELECT tool_id, COUNT(*) as recipes
  FROM harvesting_data
  GROUP BY tool_id;
"

# Find what rewards come from harvesting a specific corpse
sqlite3 progress.db "
  SELECT corpse_id, reward_id, percent_chance
  FROM harvesting_data
  WHERE corpse_id = 3101
  ORDER BY percent_chance DESC;
"
```

```{r}
# Harvesting success rate distribution
harvesting_recipes |>
  ggplot(aes(x = percent_chance)) +
  geom_histogram(bins = 20) +
  labs(title = "Harvesting Success Rate Distribution",
       x = "Success Rate %",
       y = "Count")
```

## Closing Database Connection

```{r}
dbDisconnect(db)
```

## Skill IDs Reference

When parsing .usr files, skills are identified by the following IDs:

| Skill ID | Skill Name        |
|----------|-------------------|
| 0        | Level             |
| 1        | Magic Level       |
| 6        | Fist Fighting     |
| 7        | Club Fighting     |
| 8        | Sword Fighting    |
| 9        | Axe Fighting      |
| 10       | Distance Fighting |
| 11       | Shielding         |
| 14       | Fishing           |

## USR File Format

The .usr files contain player data in the following format:

```
ID              = 100001
Name            = "PlayerName"
...
Skill = (0,108,0,1,0,0,0,0,0,0,1,20000100,0,20426400,100)  # Level/Exp
Skill = (1,75,0,1,0,0,0,0,0,0,1,20000100,0,20426400,100)   # Magic Level
...
QuestValues = {(20,1),(25,1),(227,5)}
Bestiary    = {(15,8),(21,6),(27,3)}
Harvesting  = {(10,5),(15,3),(20,1)}
Inventory   = {3 Content={5272}, 10 Content={2854}}
```

## Session Info

```{r, eval = TRUE}
sessionInfo()
```
